#include "PS2_Get.h"

#include "delay.h"
/*********************************************************     
**********************************************************/
#define DELAY_TIME delay_us(5);
u16 Handkey;														 // 按键值读取，零时存储。
uint8_t Mode,PS2_Start;
u8 Comd[2] = {0x01, 0x42};											 //开始命令。请求数据
u8 Data[9] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}; //数据存储数组
uint8_t Get_PS2key[16]={0};			/* 按键键码存放数组 */
u16 MASK[] = {
	PSB_SELECT,
	PSB_L3,
	PSB_R3,
	PSB_START,
	PSB_PAD_UP,
	PSB_PAD_RIGHT,
	PSB_PAD_DOWN,
	PSB_PAD_LEFT,
	PSB_L2,
	PSB_R2,
	PSB_L1,
	PSB_R1,
	PSB_GREEN,
	PSB_RED,
	PSB_BLUE,
	PSB_PINK};


	
	
/**************************************************************************
函数功能：向手柄发送命令,并接收接收器发来的数据
入口参数：CMD指令
返回  值：无
**************************************************************************/
void PS2_Cmd(u8 CMD)
{
	volatile u16 ref = 0x01;
	Data[1] = 0;            //接收到的数据(位)
	for (ref = 0x01; ref < 0x0100; ref <<= 1)
	{
		if (ref & CMD)
		{
			DO_H; //输出一位控制位
		}
		else
			DO_L;

		CLK_H; //时钟拉高
		DELAY_TIME;
		CLK_L;
		DELAY_TIME;
		CLK_H;
		if (DI)
			Data[1] = ref | Data[1];
	}
	delay_us(16);
}
/**************************************************************************
函数功能：判断是否为红灯模式,0x41=模拟绿灯，0x73=模拟红灯
入口参数：CMD指令
返回  值：2->红绿灯模式  1->绿灯
**************************************************************************/
u8 PS2_RedLight(void)
{
	CS_L;
	PS2_Cmd(Comd[0]); //开始命令
	PS2_Cmd(Comd[1]); //请求数据
	CS_H;
	if (Data[1] == 0X73) Mode=2;
//		return 2;
	else Mode=1;
//		return 1;
}
/**************************************************************************
函数功能：读取手柄数据
入口参数：无
返回  值：无
**************************************************************************/

//按十六进制位形式接受按下对应按键发送的数据(0000 0000)

void PS2_ReadData(void)
{
	volatile u8 byte = 0;
	volatile u16 ref = 0x01;
	CS_L;
	PS2_Cmd(Comd[0]);				 //开始命令
	PS2_Cmd(Comd[1]);				 //请求数据
	for (byte = 2; byte < 9; byte++) //开始接受数据
	{
		for (ref = 0x01; ref < 0x100; ref <<= 1)
		{
			CLK_H;
			DELAY_TIME;
			CLK_L;
			DELAY_TIME;
			CLK_H;
			if (DI)
				Data[byte] = ref | Data[byte];
		}
		delay_us(16);
	}
	CS_H;
}
/**************************************************************************
函数功能：对读出来的PS2的数据进行处理,只处理按键部分
入口参数：CMD指令
返回  值：无  
//只有一个按键按下时按下为0， 未按下为1

return->0 -->无按键按下

return->1 -->SELECT
			->2 -->左摇杆按键
			->3 -->右摇杆按键
			->4 -->START
			->5 -->靠左 上按键
			->6 -->靠左 右按键
			->7 -->靠左 下按键
			->8 -->靠左 左按键
			->9 -->前置 左下按键
			->10 -->前置 右下按键
			->11 -->前置 左上按键
			->12 -->前置 右上按键
			->13 -->三角
			->14 -->圆
			->15 -->×
			->16 -->方形

**************************************************************************/
void PS2_DataKey()
{
	u8 index;

	PS2_ClearData();
	PS2_ReadData();

	Handkey = (Data[4] << 8) | Data[3]; //这是16个按键  按下为0， 未按下为1
	for (index = 0; index < 16; index++)
	{
		if ((Handkey & (1 << (MASK[index] - 1))) == 0)  //有其中一个按键按下
		{
				Get_PS2key[index] = 1;
		}
		else Get_PS2key[index] =0;
	}
//	return 0; //没有任何按键按下
}
/**************************************************************************
函数功能：向手柄发送命令
入口参数：得到一个摇杆的模拟量	 范围0~256
返回  值：无
**************************************************************************/
u8 PS2_AnologData(u8 button)
{
	return Data[button];
}

//清除数据缓冲区
void PS2_ClearData()
{
	u8 a;
	for (a = 0; a < 9; a++)
		Data[a] = 0x00;
}
/******************************************************
函数功能: 手柄震动函数，
Calls:		 void PS2_Cmd(u8 CMD);
入口参数: motor1:右侧小震动电机 0x00关，其他开
	        motor2:左侧大震动电机 0x40~0xFF 电机开，值越大 震动越大
返回  值:无
******************************************************/
void PS2_Vibration(u8 motor1, u8 motor2)
{
	CS_L;
	delay_us(16);
	PS2_Cmd(0x01); //开始命令
	PS2_Cmd(0x42); //请求数据
	PS2_Cmd(0X00);
	PS2_Cmd(motor1);
	PS2_Cmd(motor2);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	CS_H;
	delay_us(16);
}
/**************************************************************************
函数功能：short poll
入口参数：无
返回  值：无
**************************************************************************/
void PS2_ShortPoll(void)
{
	CS_L;
	delay_us(16);
	PS2_Cmd(0x01);
	PS2_Cmd(0x42);
	PS2_Cmd(0X00);
	PS2_Cmd(0x00);
	PS2_Cmd(0x00);
	CS_H;
	delay_us(16);
}
/**************************************************************************
函数功能：进入配置
入口参数：无
返回  值：无
**************************************************************************/
void PS2_EnterConfing(void)
{
	CS_L;
	delay_us(16);
	PS2_Cmd(0x01);
	PS2_Cmd(0x43);
	PS2_Cmd(0X00);
	PS2_Cmd(0x01);
	PS2_Cmd(0x00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	CS_H;
	delay_us(16);
}
/**************************************************************************
函数功能：发送模式设置
入口参数：无
返回  值：无
**************************************************************************/
void PS2_TurnOnAnalogMode(void)
{
	CS_L;
	PS2_Cmd(0x01);
	PS2_Cmd(0x44);
	PS2_Cmd(0X00);
	PS2_Cmd(0x01); //analog=0x01;digital=0x00  软件设置发送模式
	PS2_Cmd(0xEE); //Ox03锁存设置，即不可通过按键“MODE”设置模式。
				   //0xEE不锁存软件设置，可通过按键“MODE”设置模式。
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	PS2_Cmd(0X00);
	CS_H;
	delay_us(16);
}
/**************************************************************************
函数功能：振动设置
入口参数：无
返回  值：无
**************************************************************************/
void PS2_VibrationMode(void)
{
	CS_L;
	delay_us(16);
	PS2_Cmd(0x01);
	PS2_Cmd(0x4D);
	PS2_Cmd(0X00);
	PS2_Cmd(0x00);
	PS2_Cmd(0X01);
	CS_H;
	delay_us(16);
}
/**************************************************************************
函数功能：完成并保存配置
入口参数：无
返回  值：无
**************************************************************************/
void PS2_ExitConfing(void)
{
	CS_L;
	delay_us(16);
	PS2_Cmd(0x01);
	PS2_Cmd(0x43);
	PS2_Cmd(0X00);
	PS2_Cmd(0x00);
	PS2_Cmd(0x5A);
	PS2_Cmd(0x5A);
	PS2_Cmd(0x5A);
	PS2_Cmd(0x5A);
	PS2_Cmd(0x5A);
	CS_H;
	delay_us(16);
}
/**************************************************************************
函数功能：手柄配置初始化
入口参数：无
返回  值：无
**************************************************************************/
void PS2_SetInit(void)
{
	PS2_ShortPoll();
	PS2_ShortPoll();
	PS2_ShortPoll();
	PS2_EnterConfing();		//进入配置模式
	PS2_TurnOnAnalogMode(); //“红绿灯”配置模式，并选择是否保存
	PS2_VibrationMode();	//开启震动模式
	PS2_ExitConfing(); //完成并保存配置
}

/* 按下START键后 */
void PS2_Enable(void)
{
		if(Get_PS2key[3]==1)
		{
				PS2_Start=1;
		}
}


